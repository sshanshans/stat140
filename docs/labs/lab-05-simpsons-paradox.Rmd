---
title: "Lab 05 - Simpson's paradox"
date: "due Mon, Feb 18 at 11:59p"
output: 
  tufte::tufte_html:
    tufte_variant: "envisioned"
    highlight: pygments
    css: "./sta199-labs.css"
link-citations: yes
---

```{r include=FALSE}
library(tidyverse)
library(tufte)
library(knitr)
options(
  htmltools.dir.version = FALSE, # for blogdown
  show.signif.stars = FALSE,     # for regression output
  digits = 2
  )
knitr::opts_chunk$set(eval = FALSE)
```

## Introduction

```{r fig.margin=TRUE, eval=TRUE, echo=FALSE}
include_graphics("img/05-simpsons-paradox/whickham.png")
```

A study of conducted in Whickham, England recorded participants' age, smoking status at baseline, and then 20 years later recorded their health outcome.

# Getting started

- Go to the course organization on GitHub: [http://github.com/STA199-Sp19](http://github.com/STA199-Sp19). 

- Find the repo starting with `lab-05` and that has your team name at the end.

- In the repo, click on the green **Clone or download** button, select **Use HTTPS** (this might already be selected by default, and if it is, you'll see the text **Clone with HTTPS** as in the image below). Click on the clipboard icon to copy the repo URL.

- Go to RStudio Cloud and into the course workspace. Create a **New Project from Git Repo**. You will need to click on the down arrow next to the **New Project** button to see this option.

- Copy and paste the URL of your assignment repo into the dialog box:

- Hit OK, and you're good to go!

# Packages

In this lab we will work with the `tidyverse` and `mosaicData` packages. 
So we need to install and load them:

```{r eval = FALSE}
library(tidyverse) 
library(mosaicData) 
```

Note that these packages are also loaded in your R Markdown document.

# Housekeeping 

## Git configuration

Use the `use_git_config()` function from the `usethis` package to configure Git, so RStudio and GitHub can communicate with each other.

Type the following lines of code in the **console** in RStudio filling in your name and email address.

```{marginfigure}
Your email address is the address tied to your GitHub account and your name should be first and last name.
```

```{r eval=FALSE}
library(usethis)
use_git_config(user.name="your name", user.email="your email")
```

Once you run the code, your values for `user.name` and `user.email` will show in the console. If your `user.name` and `user.email` are correct, you're good to go! Otherwise, run the code again with the necessary changes. 

## Password caching

If you would like your git password cached for a week for this project, type the following in the **Terminal**:

```{bash eval=FALSE}
git config --global credential.helper 'cache --timeout 604800'
```

You will need to enter your GitHub username and password one more time after caching the password. After that you won't need to enter your credentials for 604800 seconds = 7 days.

## Project name: 

Currently your project is called *Untitled Project*. Update the name of your project to be "Lab 05 - Simpson's paradox".

# Warm up

**Pick one team member to complete the steps in this section while the others contribute to the discussion but do not actually touch the files on their computer.**

Before we introduce the data, let's warm up with some simple exercises.

## YAML: 

Open the R Markdown (Rmd) file in your project, change the author name to your **team** name, and knit the document.

## Commiting and pushing changes:

- Go to the **Git** pane in your RStudio. 
- View the **Diff** and confirm that you are happy with the changes.
- Add a commit message like "Update team name" in the **Commit message** box and hit **Commit**.
- Click on **Push**. This will prompt a dialogue box where you first need to enter your user name, and then your password.

## Pulling changes:

Now, the remaining team members who have not been concurrently making these changes on their projects should click on the **Pull** button in their Git pane and observe that the changes are now reflected on their projects as well.

# The data

The data is in the `mosaicData` package. You can load it with

```{r load-data}
data(Whickham)
```

Take a look at the codebook with

```{r eval=FALSE}
?Whickham
```

or at https://www.rdocumentation.org/packages/mosaicData/versions/0.14.0/topics/Whickham.

# Exercises

**Write your R code using the [style guidelines discussed in class](https://www2.stat.duke.edu/courses/Spring19/sta199.001/slides/lec-slides/05b-coding-style-data-types.html#1).**

1. What type of study do you think these data come from: observational 
   or experiment? Why?

2. How many observations are in this dataset? What does each observation 
   represent?

3. How many variables are in this dataset? What type of variable is each? 
   Display each variable using an appropriate visualization.

4. What would you expect the relationship between smoking status and 
   health outcome to be?

5. Create a visualization depicting the relationship between smoking status 
   and health outcome. Briefly describe the relationship, and evaluate whether 
   this meets your expectations. Additionally, calculate the relevant
   conditional probabilities to help your narrative. Here is some code to 
   get you started:

```{r}
Whickham %>%
  count(smoker, outcome)
```

6. Create a new variable called `age_cat` using the following scheme:

- `age <= 44 ~ "18-44"`
- `age > 44 & age <= 64 ~ "45-64"`
- `age > 64 ~ "65+"`

7. Re-create the visualization depicting the relationship between smoking 
status and health outcome, faceted by `age_cat`. What changed? What might 
explain this change? Extend the contingency table from earlier by 
breaking it down by age category and use it to help your narrative.

```{r}
Whickham %>%
  count(smoker, age_cat, outcome)
```

*Review your .md file on GitHub to make sure it is fully updated and includes all of your final output, graphs and narrative. There is a 10% penalty if the .Rmd file has to be knitted to display graphs, i.e. the graphs are not showing in the .md file on GitHub.*
    