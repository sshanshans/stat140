---
title: "Coding style + Data types + Recoding"
author: "Dr. Maria Tackett"
date: "02.11.19"
output:
  xaringan::moon_reader:
    mathjax: "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML"
    css: "sta199-slides.css"
    logo: img/sta199-sticker-icon.png
    lib_dir: libs
    nature: 
      highlightLines: true
      highlightStyle: github
      countIncrementalSlides: false
---

layout: true

<div class="my-footer">
<span>
<a href="http://datasciencebox.org" target="_blank">datasciencebox.org</a>
</span>
</div> 

---

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)
library(emo)
library(DT)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning=FALSE,
                      message=FALSE,
                      fig.height = 2.65, 
                      dpi = 300) 
# For nonsese...
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
# For magick
dev.off <- function(){
  invisible(grDevices::dev.off())
}
```


## Announcements

- HW 02 due tonight at 11:59p

- Writing ex 02 due tonight at 11:59p

- Exam 01 due Friday at 11:59p (more detail at the end of class)

---

class: center, middle

# Coding style

---

## Style guide

>"Good coding style is like correct punctuation: you can manage without it, butitsuremakesthingseasiertoread."
>
>Hadley Wickham

- Style guide for this course is based on the Tidyverse style guide: [http://style.tidyverse.org/](http://style.tidyverse.org/)

- There's more to it than what we'll cover today. We'll mention more as we introduce more functionality throughout the semester.

---

### File names and code chunk labels

- Do not use spaces in file names, use `-` or `_` to separate words

- Use all lowercase letters

```{r eval = FALSE}
# Good
ucb-admit.csv

# Bad
UCB Admit.csv
```

---

## Object names

- Use `_` to separate words in object names

- Use informative but short object names

- Do not reuse object names within an analysis

```{r eval = FALSE}
# Good
acs_employed

# Bad
acs.employed
acs2
acs_subset
acs_subsetted_for_males
```

---

## Spacing

- Put a space before and after all infix operators (=, +, -, <-, etc.), and when naming arguments in function calls. 

- Always put a space after a comma, and never before (just like in regular English).

```{r eval = FALSE}
# Good
average <- mean(feet / 12 + inches, na.rm = TRUE)

# Bad
average<-mean(feet/12+inches,na.rm=TRUE)
```

---

## ggplot

- Always end a line with `+`

- Always indent the next line

```{r eval = FALSE}
# Good
ggplot(diamonds, mapping = aes(x = price)) +
  geom_histogram()

# Bad
ggplot(diamonds,mapping=aes(x=price))+geom_histogram()
```

---

## Long lines

- Try to limit your code to 80 characters per line. This fits comfortably on a printed page with a reasonably sized font.

- Take advantage of RStudio editor's auto formatting for indentation at line breaks.

---

## Assignment

- Use `<-`  not `=`

```{r eval = FALSE}
# Good
x <- 2

# Bad
x = 2
```

---

## Quotes

Use `"`, not `'`, for quoting text. The only exception is when the text already contains double quotes and no single quotes.

```{r eval = FALSE}
ggplot(diamonds, mapping = aes(x = price)) +
  geom_histogram() +
  # Good
  labs(title = "`Shine bright like a diamond`",
  # Good
       x = "Diamond prices",
  # Bad
       y = 'Frequency')
```

---

class: center, middle

# Data types

---

## Data types in R

* **logical**

* **double**

* **integer**

* **character**

* **lists**

* and some more, but we won't be focusing on those

---

## Logical & character

**logical** - Boolean values `TRUE` and `FALSE`

```{r}
typeof(TRUE)
```

--

**character** - character strings

```{r}
typeof("hello")
```

---

## Double & integer

**double** - floating point numerical values (default numerical type)

.midi[
```{r}
typeof(1.335)
typeof(7)
```
]

--

**integer** - integer numerical values (indicated with an `L`)

.midi[
```{r}
typeof(7L)
typeof(1:3)
```
]

---

## Lists

- **Lists** are 1d objects that can contain any combination of R objects

```{r}
mylist <- list("A", 1:4, c(TRUE, FALSE), (1:4)/2)
mylist
```

---

## Lists

```{r}
str(mylist)
```

---

## Named lists

Because of their more complex structure we often want to name the elements of a list (we can also do this with vectors). This can make reading and accessing the list more 
straight forward.

.small[
```{r}
myotherlist <- list(A = "hello", B = 1:4, "knock knock" = "who's there?")
str(myotherlist)
names(myotherlist)
myotherlist$B
```
]

---

## Concatenation

Vectors can be constructed using the `c()` function.

```{r}
c(1, 2, 3)
c("Hello", "World!")
c(1, c(2, c(3)))
```

---

## Coercion

R is a dynamically typed language -- it will easily convert between various types

```{r}
c(1, "Hello")
c(FALSE, 3L)
c(1.2, 3L)
```


In general, R will convert all values to the simplest type needed to represent all the information
---

## Missing Values

R uses `NA` to represent missing values in its data structures.

```{r}
typeof(NA)
```

---

## Other Special Values

`NaN` - Not a number

`Inf` - Positive infinity

`-Inf` - Negative infinity

.pull-left[
```{r}
pi / 0
0 / 0
1/0 + 1/0
```
]
.pull-right[
```{r}
1/0 - 1/0
NaN / NA
NaN * NA
```
]

---

## Activity

.question[
What is the type of the following vectors? Explain why they have that type.
]

1. `c(1, NA+1L, "C")`
2. `c(1L / 0, NA)`
3. `c(1:3, 5)`
4. `c(3L, NaN+1L)`
5. `c(NA, TRUE)`

---

## Example: Cat lovers

A survey asked respondents their name and number of cats. The instructions said to enter the number of cats as a numerical value.

```{r message=FALSE}
cat_lovers <- read_csv("data/cat-lovers.csv")
```

```{r echo=FALSE}
cat_lovers %>%
  datatable()
```

---

## Why isn't this working?!

```{r}
cat_lovers %>%
  summarise(mean = mean(number_of_cats))
```

---

## Why is this still not working??!!

```{r}
cat_lovers %>%
  summarise(mean_cats = mean(number_of_cats, na.rm = TRUE))
```

---

## Let's look at the data...

.question[
What is the type of the `number_of_cats` variable?
]

```{r}
glimpse(cat_lovers)
```

---

## Let's take another look

.small[
```{r echo=FALSE}
cat_lovers %>%
  datatable()
```
]

---

### Sometimes you have to fix data entry errors

```{r}
cat_lovers %>%
  mutate(number_of_cats = case_when(
    name == "Ginger Clark" ~ 2,
    name == "Doug Bass"    ~ 3,
    TRUE                   ~ as.numeric(number_of_cats)
    )) %>%
  summarise(mean_cats = mean(number_of_cats))
```

---

### You always need to respect data types

```{r}
cat_lovers %>%
  mutate(
    number_of_cats = case_when(
      name == "Ginger Clark" ~ "2",
      name == "Doug Bass"    ~ "3",
      TRUE                   ~ number_of_cats
      ),
    number_of_cats = as.numeric(number_of_cats)
    ) %>%
  summarise(mean_cats = mean(number_of_cats))
```

---

### Now that we know what we're doing...

```{r}
cat_lovers <- cat_lovers %>%
  mutate(
    number_of_cats = case_when(
      name == "Ginger Clark" ~ "2",
      name == "Doug Bass"    ~ "3",
      TRUE                   ~ number_of_cats
      ),
    number_of_cats = as.numeric(number_of_cats)
    )
```

---

## Moral of the story

- If your data does not behave how you expect it to, type coercion upon reading in the data might be the reason.


- Go in and investigate your data, apply the fix, **save your data**, live happily ever after.

---

## Vectors vs. lists

.pull-left[
**Vectors**
.small[
```{r, error=TRUE}
x <- c(8,4,7)
```
]
.small[
```{r}
x[1]
```
]
.small[
```{r}
x[[1]]
```
]
]
--
.pull-right[
**Lists**
.small[
```{r}
y <- list(8,4,7)
```
]
.small[
```{r}
y[2]
```
]
.small[
```{r}
y[[2]]
```
]
]

--

**Note:** When using tidyverse code you'll rarely need to refer to elements using square brackets, but it's good to be aware of this syntax, especially since you might encounter it when searching for help online.

---

class: center, middle

# Data "set"

---

## Data "sets" in R

- "set" is in quotation marks because it is not a formal data class

- A tidy data "set" can be one of the following types:
    + `tibble`
    + `data.frame`
    
---

## Data frames & tibbles

- A `data.frame` is the most commonly used data structure in R, they are just a list of equal length vectors. Each vector is treated as a column and elements of the vectors as rows.

- A tibble is a type of data frame that ... makes the data analysis easier.

- Most often a data frame will be constructed by reading in from a file, but we can also create them from scratch.
    - `readr` package (e.g. `read_csv` function) loads data as a `tibble` by default
    - `tibble`s are part of the tidyverse, so they work well with other packages we are using
    - they make minimal assumptions about your data, so are less likely to cause hard to track bugs in your code

---

## Creating data frames

```{r}
df <- tibble(x = 1:3, y = c("a", "b", "c"))
class(df)
glimpse(df)
```

---

## Features of data frames

```{r}
attributes(df)
class(df$x)
class(df$y)
```

---

## Working with tibbles in pipelines

.question[
How many respondents have below average number of cats?
]

--

```{r}
mean_cats <- cat_lovers %>%
  summarise(mean_cats = mean(number_of_cats))

cat_lovers %>%
  filter(number_of_cats < mean_cats) %>%
  nrow()
```

.question[
Do you believe this number? Why, why not?
]

---

## A result of a pipeline is always a tibble

```{r}
mean_cats
class(mean_cats)
```

---

## `pull()` can be great

But use it sparingly!

```{r}
mean_cats <- cat_lovers %>%
  summarise(mean_cats = mean(number_of_cats)) %>%
  pull()

cat_lovers %>%
  filter(number_of_cats < mean_cats) %>%
  nrow()
```

--

```{r}
mean_cats
class(mean_cats)
```

---

class: center, middle

# Factors

---

## Factors

**Factor** objects are what R uses to store data for categorical variables (fixed numbers of discrete values).

```{r}
(x = factor(c("BS", "MS", "PhD", "MS")))
```

```{r}
glimpse(x)
```

```{r}
typeof(x)
```

---

## Read data in as character strings

```{r}
glimpse(cat_lovers)
```

---

## But coerce when plotting

```{r}
ggplot(cat_lovers, mapping = aes(x = handedness)) +
  geom_bar()
```

---

### Use forcats to manipulate factors

```{r}
cat_lovers <- cat_lovers %>%
  mutate(handedness = fct_relevel(handedness, 
                                  "right", "left", "ambidextrous"))
```

```{r}
ggplot(cat_lovers, mapping = aes(x = handedness)) +
  geom_bar()
```

---

## forcats

.center[
![](img/05b/hex-forcats.png)
]

- R uses factors to handle categorical variables, variables that have a fixed and known set of possible values. Historically, factors were much easier to work with than character vectors, so many base R functions automatically convert character vectors to factors.

- However, factors are still useful when you have true categorical data, and when you want to override the ordering of character vectors to improve display. The goal of the forcats package is to provide a suite of useful tools that solve common problems with factors.

Source: [forcats.tidyverse.org](http://forcats.tidyverse.org/)

---

## Recap

- Always best to think of data as part of a tibble
    + This works nicely with the `tidyverse` as well
    + Rows are observations, columns are variables
    
- Be careful about data types / classes
    + Sometimes `R` makes silly assumptions about your data class 
        + Using `tibble`s help, but it might not solve all issues
        + Think about your data in context, e.g. 0/1 variable is most likely a `factor`
    + If a plot/output is not behaving the way you expect, first
    investigate the data class
    + If you are absolutely sure of a data class, over-write it in your
    tibble so that you don't need to keep having to keep track of it
        + `mutate` the variable with the correct class
---

## Exam 01 

- Exam 01 due <font class="vocab">Friday at 11:59p </font>

- Read the exam rules! 
    - This is an **individual assignment** - you may not talk about the exam with anyone other than me or the TAs
    - Make sure to knit, commit, and push your .Rmd and .md documents frequently

- There is **no lecture on Wednesday** -- use this time to work on the exam 
    - This will also be used for office hours - I will be in the classroom along with TAs to answer clarifying questions 
    
- There **is** lab on Thursday 
